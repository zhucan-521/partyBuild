<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yizheng.partybuilding.repository.TabPbActivitiesMapper">
    <resultMap id="BaseResultMap" type="com.yizheng.partybuilding.entity.TabPbActivities">
        <id column="activities_id" jdbcType="BIGINT" property="activitiesId"/>
        <result column="org_id" jdbcType="BIGINT" property="orgId"/>
        <result column="org_name" jdbcType="VARCHAR" property="orgName"/>
        <result column="activities_type" jdbcType="BIGINT" property="activitiesType"/>
        <result column="activities_type_ids" jdbcType="BIGINT" property="activitiesTypeIds"/>
        <result column="invite_partener" jdbcType="TINYINT" property="invitePartener"/>
        <result column="invite_link_leader" jdbcType="TINYINT" property="inviteLinkLeader"/>
        <result column="commune_count" jdbcType="BIGINT" property="communeCount"/>
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime"/>
        <result column="finished_time" jdbcType="TIMESTAMP" property="finishedTime"/>
        <result column="activity_place" jdbcType="VARCHAR" property="activityPlace"/>
        <result column="due_count" jdbcType="BIGINT" property="dueCount"/>
        <result column="fact_count" jdbcType="BIGINT" property="factCount"/>
        <result column="formal_count" jdbcType="BIGINT" property="formalCount"/>
        <result column="probationary_count" jdbcType="BIGINT" property="probationaryCount"/>
        <result column="subject" jdbcType="VARCHAR" property="subject"/>
        <result column="status" jdbcType="BIGINT" property="status"/>
        <result column="leader_list" jdbcType="VARCHAR" property="leaderList"/>
        <result column="record_time" jdbcType="TIMESTAMP" property="recordTime"/>
        <result column="recorder_person" jdbcType="VARCHAR" property="recorderPerson"/>
        <result column="distrub_time" jdbcType="TIMESTAMP" property="distrubTime"/>
        <result column="distrub_person" jdbcType="VARCHAR" property="distrubPerson"/>
        <result column="audit_time" jdbcType="TIMESTAMP" property="auditTime"/>
        <result column="audit_user" jdbcType="BIGINT" property="auditUser"/>
        <result column="audit_user_name" jdbcType="VARCHAR" property="auditUserName"/>
        <result column="audit_org" jdbcType="BIGINT" property="auditOrg"/>
        <result column="audit_org_name" jdbcType="VARCHAR" property="auditOrgName"/>
        <result column="audit_result" jdbcType="BIGINT" property="auditResult"/>
        <result column="audit_comment" jdbcType="VARCHAR" property="auditComment"/>
        <result column="ebl_flag" jdbcType="VARCHAR" property="eblFlag"/>
        <result column="del_flag" jdbcType="VARCHAR" property="delFlag"/>
        <result column="order_num" jdbcType="BIGINT" property="orderNum"/>
        <result column="description" jdbcType="VARCHAR" property="description"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="create_userid" jdbcType="BIGINT" property="createUserid"/>
        <result column="create_username" jdbcType="VARCHAR" property="createUsername"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="update_userid" jdbcType="BIGINT" property="updateUserid"/>
        <result column="update_username" jdbcType="VARCHAR" property="updateUsername"/>
        <result column="version" jdbcType="BIGINT" property="version"/>
        <result column="moderator_name" jdbcType="VARCHAR" property="moderatorName"/>
        <result column="moderator_id" jdbcType="BIGINT" property="moderatorId"/>
        <result column="moderator_data_id" jdbcType="BIGINT" property="moderatorDataId"/>
        <result column="report_to_type" jdbcType="BIGINT" property="reportToType"/>
        <result column="stick_num" jdbcType="BIGINT" property="stickNum"/>
    </resultMap>
    <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="com.yizheng.partybuilding.entity.TabPbActivities">
        <result column="prepare" jdbcType="LONGVARCHAR" property="prepare"/>
        <result column="content" jdbcType="LONGVARCHAR" property="content"/>
        <result column="effect" jdbcType="LONGVARCHAR" property="effect"/>
        <result column="correction" jdbcType="LONGVARCHAR" property="correction"/>
    </resultMap>

    <resultMap extends="ResultMapWithBLOBs" id="ResultMapWithCount"
               type="com.yizheng.partybuilding.dto.PartyOrganizationActivitiesDto">
        <result column="attachment_instance" jdbcType="VARCHAR" property="attachment"/>
        <result column="deptName" jdbcType="VARCHAR" property="deptName"/>
        <result column="superiorName" jdbcType="VARCHAR" property="superiorName"/>
        <result column="attendanceRate" jdbcType="BIGINT" property="attendanceRate"/>
        <result column="photo" property="photo" jdbcType="BIGINT"/>
        <result column="video" property="video" jdbcType="BIGINT"/>
        <result column="doc" property="doc" jdbcType="BIGINT"/>
        <result column="fact_count" property="functionAttendance" jdbcType="BIGINT"/>
        <result column="due_count" property="headcount" jdbcType="BIGINT"/>
        <result column="absenteeNumber" property="absenteeNumber" jdbcType="BIGINT"/>
        <result column="join_name_string" property="joinNameString" jdbcType="VARCHAR"/>
        <result column="unjoin_name_string" property="unjoinNameString" jdbcType="VARCHAR"/>
        <result column="orgnize_master" property="orgnizeMaster" jdbcType="VARCHAR"/>
        <result column="unit_name" property="unitName" jdbcType="VARCHAR"/>
        <result column="user_id" property="userIds" jdbcType="BIGINT"/>
    </resultMap>

    <!--包含附件的ResultMap-->
    <resultMap extends="ResultMapWithCount" id="ResultMapWithAbout" type="com.yizheng.partybuilding.dto.PartyOrganizationActivitiesDto">
        <collection property="documents"
                    select="com.yizheng.partybuilding.repository.TabPbAttachmentMapper.selectWithConditions"
                    column="{hostId=activities_id,attachmentType=attachment_type,fileTypeLabel=file_type_doc}"/>
        <collection property="pictures"
                    select="com.yizheng.partybuilding.repository.TabPbAttachmentMapper.selectWithConditions"
                    column="{hostId=activities_id,attachmentType=attachment_type,fileTypeLabel=file_type_img}"/>
        <collection property="videos"
                    select="com.yizheng.partybuilding.repository.TabPbAttachmentMapper.selectWithConditions"
                    column="{hostId=activities_id,attachmentType=attachment_type,fileTypeLabel=file_type_video}"/>

        <collection property="tabPbParticipant"
                    select="com.yizheng.partybuilding.repository.TabPbParticipantMapper.selectSimpleListWithConditions"
                    column="activitiesId=activities_id,delFlag=del_flag,moderatorId=moderator_id"/>
    </resultMap>

    <!--结对共建ResultMap-->
    <resultMap extends="ResultMapWithCount" id="PairingResultMap" type="com.yizheng.partybuilding.dto.PartyOrganizationActivitiesDto">
        <result column="pair_org_id" jdbcType="BIGINT" property="pairOrgId"/>
        <result column="pair_org_name" jdbcType="VARCHAR" property="pairOrgName"/>
    </resultMap>
    <resultMap extends="ResultMapWithAbout" id="PairingResultMapWithAnnex" type="com.yizheng.partybuilding.dto.PartyOrganizationActivitiesDto">
        <result column="pair_org_id" jdbcType="BIGINT" property="pairOrgId"/>
        <result column="pair_org_name" jdbcType="VARCHAR" property="pairOrgName"/>
    </resultMap>

    <!--活动排除人员ResultMap-->
    <resultMap id="ExclusionMemberResultMap" type="com.yizheng.partybuilding.dto.ActivityExclusionParticipantDto">
        <result column="org_id" jdbcType="BIGINT" property="orgId"/>
        <result column="org_name" jdbcType="VARCHAR" property="orgName"/>
        <result column="pair_org_id" jdbcType="BIGINT" property="pairOrgId"/>
        <result column="pair_org_name" jdbcType="VARCHAR" property="pairOrgName"/>
        <collection property="nltr" select="com.yizheng.partybuilding.repository.TabPbActivitiesMapper.selectCandidateMemberListWithConditions"
                    column="orgId=org_id,pairOrgId=pair_org_id,userTag=nltr"/>
        <collection property="jcwc" select="com.yizheng.partybuilding.repository.TabPbActivitiesMapper.selectCandidateMemberListWithConditions"
                    column="orgId=org_id,pairOrgId=pair_org_id,userTag=jcwc"/>
    </resultMap>

    <resultMap extends="ResultMapWithBLOBs" id="TabPbActivitiesDtoMap" type="com.yizheng.partybuilding.dto.TabPbActivitiesDto">
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="photo" property="photo"/>
        <result column="video" property="video"/>
        <result column="doc" property="doc"/>
        <result column="report_org_name" property="reportOrgName"/>
        <result column="username" property="username"/>
    </resultMap>

    <!--联席会活动候选参与者列表-->
    <resultMap id="JoinMeetActivitiesPreUserResultMap" type="com.yizheng.partybuilding.dto.JointMeetUsersDto">
        <result column="positive_id" jdbcType="BIGINT" property="positiveId"/>
        <result column="positive_name" jdbcType="VARCHAR" property="positiveName"/>
        <result column="unit_id" jdbcType="BIGINT" property="unitId"/>
        <result column="unit_name" jdbcType="VARCHAR" property="unitName"/>
        <result column="org_id" jdbcType="BIGINT" property="orgId"/>
        <result column="org_name" jdbcType="VARCHAR" property="orgName"/>
        <result column="user_id" jdbcType="BIGINT" property="userId"/>
        <result column="user_name" jdbcType="VARCHAR" property="userName"/>
        <result column="id_card_no" jdbcType="VARCHAR" property="idCardNo"/>
        <result column="participant_id" jdbcType="BIGINT" property="participantId"/>
    </resultMap>

    <sql id="Base_Column_List">
    activities_id, org_id, activities_type, activitiesTypeIds, invite_partener, invite_link_leader,
    commune_count, start_time, finished_time, activity_place, due_count, fact_count, formal_count, probationary_count, subject,
    status, leader_list, record_time, recorder_person, distrub_time, distrub_person, audit_time, audit_result,
    audit_user, audit_org, audit_comment, ebl_flag, del_flag, order_num, description, create_time,
    create_userid, create_username, update_time, update_userid, update_username, version ,report_to_type
  </sql>
    <sql id="Blob_Column_List">
    prepare, content, effect, correction
  </sql>

    <!--结对共建WhereCase-->
    <sql id="Pairing_Base_WhereCase_List">
        <if test="activitiesId != null and activitiesId != ''">
            AND a.activities_id = #{activitiesId}
        </if>
        <if test="orgId != null and orgId != ''">
            AND a.org_id = #{orgId}
        </if>
        <if test="activitiesType != null and activitiesType != ''">
            AND a.activities_type = #{activitiesType}
        </if>
        <if test="communeCount != null and communeCount != ''">
            AND a.commune_count = #{communeCount}
        </if>
        <if test="startTime != null and startTime != ''">
            AND a.start_time = #{startTime}
        </if>
        <if test="finishedTime != null and finishedTime != ''">
            AND a.finished_time = #{finishedTime}
        </if>
        <if test="activityPlace != null and activityPlace != ''">
            AND a.activity_place = #{activityPlace}
        </if>
        <if test="dueCount != null and dueCount != ''">
            AND a.due_count = #{dueCount}
        </if>
        <if test="factCount != null and factCount != ''">
            AND a.fact_count = #{factCount}
        </if>
        <if test="formalCount != null and formalCount != ''">
            AND a.formal_count = #{formalCount}
        </if>
        <if test="probationaryCount != null and probationaryCount != ''">
            AND a.probationary_count = #{probationaryCount}
        </if>
        <if test="subject != null and subject != ''">
            AND a.subject = #{subject}
        </if>
        <if test="status != null and status != ''">
            AND a.status = #{status}
        </if>
        <if test="leaderList != null and leaderList != ''">
            AND a.leader_list = #{leaderList}
        </if>
        <if test="recordTime != null and recordTime != ''">
            AND a.record_time = #{recordTime}
        </if>
        <if test="recorderPerson != null and recorderPerson != ''">
            AND a.recorder_person = #{recorderPerson}
        </if>
        <if test="distrubTime != null and distrubTime != ''">
            AND a.distrub_time = #{distrubTime}
        </if>
        <if test="distrubPerson != null and distrubPerson != ''">
            AND a.distrub_person = #{distrubPerson}
        </if>
        <if test="auditStartTime != null and auditStartTime != ''">
            AND date_format(a.audit_time, '%Y-%m-%d') >= #{auditStartTime}
        </if>
        <if test="auditEndTime != null and auditEndTime != ''">
            AND date_format(a.audit_time, '%Y-%m-%D') &lt;= #{auditEndTime}
        </if>
        <if test="auditResult != null and auditResult != ''">
            AND a.audit_result = #{auditResult}
        </if>
        <if test="auditUser != null and auditUsser != ''">
            AND a.audit_user = #{auditUser}
        </if>
        <if test="auditOrg != null and auditOrg != ''">
            AND a.audit_org = #{auditOrg}
        </if>
        <if test="auditComment != null and auditComment != ''">
            AND a.audit_comment like concat('%', auditComment, '%')
        </if>
        <if test="eblFlag != null and eblFlag != ''">
            AND a.ebl_flag = #{eblFlag}
        </if>
        <if test="delFlag != null and delFlag != ''">
            AND a.del_flag = #{delFlag}
        </if>
        <if test="orderNum != null and orderNum != ''">
            AND a.order_num = #{orderNum}
        </if>
        <if test="description != null and description != ''">
            AND a.description = #{description}
        </if>
        <if test="createStartTime != null and createStartTime != ''">
            AND date_format(a.create_time, '%Y-%m-%d') >= #{createStartTime}
        </if>
        <if test="createEndTime != null and createEndTime != ''">
            AND date_format(a.create_time, '%Y-%m-%D') &lt;= #{createEndTime}
        </if>
        <if test="createUserid != null and createUserid != ''">
            AND a.create_userid = #{createUserid}
        </if>
        <if test="createUsername != null and createUsername != ''">
            AND a.create_username = #{createUsername}
        </if>
        <if test="updateTime != null and updateTime != ''">
            AND a.update_time = #{updateTime}
        </if>
        <if test="updateUserid != null and updateUserid != ''">
            AND a.update_userid = #{updateUserid}
        </if>
        <if test="updateUsername != null and updateUsername != ''">
            AND a.update_username = #{updateUsername}
        </if>
        <if test="version != null and version != ''">
            AND a.version = #{version}
        </if>
        <if test="prepare != null and prepare != ''">
            AND a.prepare = #{prepare}
        </if>
        <if test="content != null and content != ''">
            AND a.content = #{content}
        </if>
        <if test="effect != null and effect != ''">
            AND a.effect = #{effect}
        </if>
        <if test="correction != null and correction != ''">
            AND a.correction = #{correction}
        </if>
        <!--组织范围  1 当前组织（包括一级下级组织）2当前组织（包含所有下级组织） -->
        <if test="orgRange != null and orgRange != ''">
            <choose>
                <when test="orgRange == 1">
                    AND (d.dept_id = #{rangeDeptId} OR d.parent_id = #{rangeDeptId})
                </when>
                <when test="orgRange == 2">
                    AND find_in_set(#{rangeDeptId}, d.full_path)
                </when>
            </choose>
        </if>
        <if test="orgRange == null or orgRange.toString() == ''">
            AND d.dept_id = #{rangeDeptId}
        </if>
    </sql>
    <select id="selectByPrimaryKey" parameterType="com.yizheng.partybuilding.entity.TabPbActivities"
            resultMap="TabPbActivitiesDtoMap">
        SELECT a.*,dept.`name`,COUNT(if(participant.if_leader='1',TRUE,NULL)) AS communityUserCount,
        COUNT(if(participant.if_leader='0',TRUE,NULL)) AS organCommunityUserCount FROM(
        SELECT
        activi.*,COUNT(if(attac.attachment_file_type=${@com.yizheng.commons.util.AttachmentType@PHOTO},TRUE,NULL))
        AS photo,
        COUNT(if(attac.attachment_file_type=${@com.yizheng.commons.util.AttachmentType@VIDEO},TRUE,NULL)) AS
        video,
        COUNT(if(attac.attachment_file_type=${@com.yizheng.commons.util.AttachmentType@DOC},TRUE,NULL)) AS doc
        FROM
        tab_pb_activities activi
        LEFT JOIN tab_pb_attachment attac ON activi.activities_id = attac.host_id
        AND attac.attachment_type = ${@com.yizheng.commons.util.AttachmentType@ACTIVITIES} and attac.del_flag = '0'
        WHERE
        activi.del_flag = '0'
        GROUP BY activi.activities_id) a
        JOIN sys_dept dept ON a .org_id = dept.dept_id and dept.del_flag = '0'
        JOIN tab_pb_participant participant ON a .activities_id = participant.activities_id
        where true
        <if test="startTime != null ">
            AND date_format(a.start_time, '%Y-%m-%d') = date_format(#{startTime}, '%Y-%m-%d')
        </if>
        <if test="createTime != null ">
            AND date_format(a.create_time, '%Y-%m-%d') = date_format(#{createTime}, '%Y-%m-%d')
        </if>
        <if test="subject != null and subject != ''">
            and a.subject LIKE CONCAT('%',#{subject},'%')
        </if>
        <if test="orgRange != null and orgRange != ''">
            <choose>
            <when test="orgRange == 1">
                AND (dept.dept_id = #{rangeDeptId} OR dept.parent_id = #{rangeDeptId})
            </when>
            <when test="orgRange == 2">
                AND find_in_set(#{rangeDeptId}, dept.full_path)
            </when>
            </choose>
        </if>
        <if test="orgRange == null or orgRange.toString() == ''">
            AND dept.dept_id = #{rangeDeptId}
        </if>
        GROUP BY participant.activities_id
    </select>
    <insert id="insertSelective" useGeneratedKeys="true" keyProperty="activitiesId"
            parameterType="com.yizheng.partybuilding.entity.TabPbActivities">
        insert into tab_pb_activities
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orgId != null">
                org_id,
            </if>
            <if test="activitiesType != null">
                activities_type,
            </if>
            <if test="activitiesTypeIds != null">
                activities_type_ids,
            </if>
            <if test="invitePartener != null">
                invite_partener,
            </if>
            <if test="inviteLinkLeader != null">
                invite_link_leader,
            </if>
            <if test="communeCount != null">
                commune_count,
            </if>
            <if test="startTime != null">
                start_time,
            </if>
            <if test="finishedTime != null">
                finished_time,
            </if>
            <if test="activityPlace != null">
                activity_place,
            </if>
            <if test="dueCount != null">
                due_count,
            </if>
            <if test="factCount != null">
                fact_count,
            </if>
            <if test="formalCount != null">
                formal_count,
            </if>
            <if test="probationaryCount != null">
                probationary_count,
            </if>
            <if test="subject != null">
                subject,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="leaderList != null">
                leader_list,
            </if>
            <if test="recordTime != null">
                record_time,
            </if>
            <if test="recorderPerson != null">
                recorder_person,
            </if>
            <if test="distrubTime != null">
                distrub_time,
            </if>
            <if test="distrubPerson != null">
                distrub_person,
            </if>
            <if test="eblFlag != null">
                ebl_flag,
            </if>
            <if test="delFlag != null">
                del_flag,
            </if>
            <if test="orderNum != null">
                order_num,
            </if>
            <if test="description != null">
                description,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="createUserid != null">
                create_userid,
            </if>
            <if test="createUsername != null">
                create_username,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
            <if test="updateUserid != null">
                update_userid,
            </if>
            <if test="updateUsername != null">
                update_username,
            </if>
            <if test="version != null">
                version,
            </if>
            <if test="prepare != null">
                `prepare`,
            </if>
            <if test="content != null">
                content,
            </if>
            <if test="effect != null">
                effect,
            </if>
            <if test="correction != null">
                correction,
            </if>
            <if test="reportToType !=null">
                report_to_type,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="orgId != null">
                #{orgId,jdbcType=BIGINT},
            </if>
            <if test="activitiesType != null">
                #{activitiesType,jdbcType=BIGINT},
            </if>
            <if test="activitiesTypeIds != null">
                #{activitiesTypeIds,jdbcType=VARCHAR},
            </if>
            <if test="invitePartener != null">
                #{invitePartener,jdbcType=TINYINT},
            </if>
            <if test="inviteLinkLeader != null">
                #{inviteLinkLeader,jdbcType=TINYINT},
            </if>
            <if test="communeCount != null">
                #{communeCount,jdbcType=BIGINT},
            </if>
            <if test="startTime != null">
                #{startTime,jdbcType=TIMESTAMP},
            </if>
            <if test="finishedTime != null">
                #{finishedTime,jdbcType=TIMESTAMP},
            </if>
            <if test="activityPlace != null">
                #{activityPlace,jdbcType=VARCHAR},
            </if>
            <if test="dueCount != null">
                #{dueCount,jdbcType=BIGINT},
            </if>
            <if test="factCount != null">
                #{factCount,jdbcType=BIGINT},
            </if>
            <if test="formalCount != null">
                #{formalCount,jdbcType=BIGINT},
            </if>
            <if test="probationaryCount != null">
                #{probationaryCount,jdbcType=BIGINT},
            </if>
            <if test="subject != null">
                #{subject,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                #{status,jdbcType=BIGINT},
            </if>
            <if test="leaderList != null">
                #{leaderList,jdbcType=VARCHAR},
            </if>
            <if test="recordTime != null">
                #{recordTime,jdbcType=TIMESTAMP},
            </if>
            <if test="recorderPerson != null">
                #{recorderPerson,jdbcType=VARCHAR},
            </if>
            <if test="distrubTime != null">
                #{distrubTime,jdbcType=TIMESTAMP},
            </if>
            <if test="distrubPerson != null">
                #{distrubPerson,jdbcType=VARCHAR},
            </if>
            <if test="eblFlag != null">
                #{eblFlag,jdbcType=VARCHAR},
            </if>
            <if test="delFlag != null">
                #{delFlag,jdbcType=VARCHAR},
            </if>
            <if test="orderNum != null">
                #{orderNum,jdbcType=BIGINT},
            </if>
            <if test="description != null">
                #{description,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createUserid != null">
                #{createUserid,jdbcType=BIGINT},
            </if>
            <if test="createUsername != null">
                #{createUsername,jdbcType=VARCHAR},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateUserid != null">
                #{updateUserid,jdbcType=BIGINT},
            </if>
            <if test="updateUsername != null">
                #{updateUsername,jdbcType=VARCHAR},
            </if>
            <if test="version != null">
                #{version,jdbcType=BIGINT},
            </if>
            <if test="prepare != null">
                #{prepare,jdbcType=LONGVARCHAR},
            </if>
            <if test="content != null">
                #{content,jdbcType=LONGVARCHAR},
            </if>
            <if test="effect != null">
                #{effect,jdbcType=LONGVARCHAR},
            </if>
            <if test="correction != null">
                #{correction,jdbcType=LONGVARCHAR},
            </if>
            <if test="reportToType != null">
                #{reportToType,jdbcType=BIGINT}
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.yizheng.partybuilding.entity.TabPbActivities">
        update tab_pb_activities
        <set>
            <if test="orgId != null">
                org_id = #{orgId,jdbcType=BIGINT},
            </if>
            <if test="activitiesType != null">
                activities_type = #{activitiesType,jdbcType=BIGINT},
            </if>
            <if test="activitiesTypeIds != null">
                activities_type_ids = #{activitiesTypeIds,jdbcType=VARCHAR},
            </if>
            <if test="invitePartener != null">
                invite_partener = #{invitePartener,jdbcType=TINYINT},
            </if>
            <if test="inviteLinkLeader != null">
                invite_link_leader = #{inviteLinkLeader,jdbcType=TINYINT},
            </if>
            <if test="communeCount != null">
                commune_count = #{communeCount,jdbcType=BIGINT},
            </if>
            <if test="startTime != null">
                start_time = #{startTime,jdbcType=TIMESTAMP},
            </if>
            <if test="finishedTime != null">
                finished_time = #{finishedTime,jdbcType=TIMESTAMP},
            </if>
            <if test="activityPlace != null">
                activity_place = #{activityPlace,jdbcType=VARCHAR},
            </if>
            <if test="dueCount != null">
                due_count = #{dueCount,jdbcType=BIGINT},
            </if>
            <if test="factCount != null">
                fact_count = #{factCount,jdbcType=BIGINT},
            </if>
            <if test="formalCount != null">
                formal_count = #{formalCount,jdbcType=BIGINT},
            </if>
            <if test="probationaryCount != null">
                probationary_count = #{probationaryCount,jdbcType=BIGINT},
            </if>
            <if test="subject != null">
                subject = #{subject,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=BIGINT},
            </if>
            <if test="leaderList != null">
                leader_list = #{leaderList,jdbcType=VARCHAR},
            </if>
            <if test="recordTime != null">
                record_time = #{recordTime,jdbcType=TIMESTAMP},
            </if>
            <if test="recorderPerson != null">
                recorder_person = #{recorderPerson,jdbcType=VARCHAR},
            </if>
            <if test="distrubTime != null">
                distrub_time = #{distrubTime,jdbcType=TIMESTAMP},
            </if>
            <if test="distrubPerson != null">
                distrub_person = #{distrubPerson,jdbcType=VARCHAR},
            </if>
            <if test="eblFlag != null">
                ebl_flag = #{eblFlag,jdbcType=VARCHAR},
            </if>
            <if test="delFlag != null">
                del_flag = #{delFlag,jdbcType=VARCHAR},
            </if>
            <if test="orderNum != null">
                order_num = #{orderNum,jdbcType=BIGINT},
            </if>
            <if test="description != null">
                description = #{description,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createUserid != null">
                create_userid = #{createUserid,jdbcType=BIGINT},
            </if>
            <if test="createUsername != null">
                create_username = #{createUsername,jdbcType=VARCHAR},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateUserid != null">
                update_userid = #{updateUserid,jdbcType=BIGINT},
            </if>
            <if test="updateUsername != null">
                update_username = #{updateUsername,jdbcType=VARCHAR},
            </if>
            <if test="version != null">
                version = #{version,jdbcType=BIGINT},
            </if>
            <if test="prepare != null">
                prepare = #{prepare,jdbcType=LONGVARCHAR},
            </if>
            <if test="content != null">
                content = #{content,jdbcType=LONGVARCHAR},
            </if>
            <if test="effect != null">
                effect = #{effect,jdbcType=LONGVARCHAR},
            </if>
            <if test="correction != null">
                correction = #{correction,jdbcType=LONGVARCHAR},
            </if>
            <if test="reportToType != null">
                report_to_type = #{reportToType,jdbcType=BIGINT},
            </if>
        </set>
        where activities_id = #{activitiesId,jdbcType=BIGINT}
    </update>

    <update id="delete" parameterType="java.lang.Long">
        update tab_pb_activities
        set ebl_flag = 0, del_flag = 1
        where activities_id = #{activitiesId}
    </update>

    <select id="selectByActivitiesId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select * from tab_pb_activities where activities_id = #{activitiesId} and del_flag=0
    </select>

    <!--逻辑删除-->
    <update id="deleteId" parameterType="com.yizheng.partybuilding.entity.TabPbActivities">
        update tab_pb_activities set del_flag=1 where activities_id = #{activitiesId,jdbcType=BIGINT}
    </update>

    <!--按条件分页查询-->
    <select id="selectWithConditions" resultMap="ResultMapWithCount" parameterType="java.util.Map">
        SELECT
            a.activities_id,
            a.org_id,
            d.`name`,
            d.orgnize_master,
            d.unit_name,
            a.`subject`,
            a.start_time,
            a.distrub_person,
            a.activities_type,
            a.activities_type_ids,
            a.record_time,
            a.`status`,
            a.create_username,
            a.create_time,
            a.audit_result,
            a.stick_num,
            d2.`name` AS superiorName,
            (a.fact_count / (
              a.due_count - ifnull((
                SELECT count( 1 )
                FROM tab_pb_participant p
                WHERE p.activities_id = a.activities_id
                AND p.absent_reason IN ( 3, 4 )
                AND p.del_flag = 0), 0)) * 100
            ) AS attendanceRate,
            ifnull( t.img_num, 0 ) AS photo,
            ifnull( t.doc_num, 0 ) AS doc,
            ifnull( t.video_num, 0 ) AS video
        FROM
        tab_pb_activities a
        LEFT JOIN sys_dept d ON a.org_id = d.dept_id
        LEFT JOIN sys_dept d2 ON d.parent_id = d2.dept_id
        LEFT JOIN view_attachment_count t on a.activities_id = t.host_id and t.attachment_type = #{attType}
        WHERE a.del_flag = 0
        <choose>
            <when test="activitiesType == null or activitiesType == ''">
                AND (find_in_set('59055', a.activities_type_ids) OR find_in_set('59056', a.activities_type_ids)
                  OR find_in_set('59057', a.activities_type_ids) OR find_in_set('59058', a.activities_type_ids))
            </when>
            <when test="activitiesType != null and activitiesType == 59390">
                AND (find_in_set('59392', a.activities_type_ids) OR find_in_set('59393', a.activities_type_ids)
                    OR find_in_set('59394', a.activities_type_ids) OR find_in_set('59395', a.activities_type_ids)
                    OR find_in_set('59396', a.activities_type_ids) OR find_in_set('59397', a.activities_type_ids))
            </when>
            <otherwise>
                AND find_in_set(#{activitiesType}, a.activities_type_ids)
            </otherwise>
        </choose>
        <if test="orgName !=null and orgName !=''">
            AND a.org_name like CONCAT('%',#{orgName},'%')
        </if>
        <if test="subject !=null and subject !=''">
            and a.subject like CONCAT('%',#{subject},'%')
        </if>
        <if test="startTime != null and startTime != null ">
            AND date_format(a.start_time, '%Y-%m-%d') >= #{startTime}
        </if>
        <if test="finishedTime != null and finishedTime != null ">
            AND date_format(a.start_time, '%Y-%m-%d') &lt;= #{finishedTime}
        </if>
        <if test="reportToType != null and reportToType !=''">
            and a.report_to_type = #{reportToType}
        </if>
        <!--审核情况 1代表未审核 等于2代表已审核  -->
        <if test="auditResult != null and auditResult !=''">
             <choose>
                  <when test="auditResult == 1">
                         and a.audit_result = 0
                  </when>
                 <when test="auditResult == 2">
                       and a.audit_result != 0
                 </when>
                 <otherwise>
                     and a.audit_result = #{auditResult}
                 </otherwise>
             </choose>
        </if>
        <!--组织范围  1 当前组织（包括一级下级组织）2当前组织（包含所有下级组织） -->
        <if test="orgRange != null and orgRange != ''">
            <choose>
                <when test="orgRange == 1">
                    AND (d.dept_id = #{rangeDeptId} OR d.parent_id = #{rangeDeptId})
                </when>
                <when test="orgRange == 2">
                    AND find_in_set(#{rangeDeptId}, d.full_path)
                </when>
            </choose>
        </if>
        <if test="orgRange == null or orgRange.toString() == ''">
            AND d.dept_id = #{rangeDeptId}
        </if>
        order by  a.stick_num desc
    </select>
    <!--查询活动详情-->
    <select id="findDetails" parameterType="java.util.Map" resultMap="ResultMapWithAbout">
      SELECT
            a.*,
            a.org_id,
            d.NAME AS org_name,
            d.orgnize_master,
            d.unit_name,
            p.real_name AS moderator_name,
            t.join_name_string,
            t.unjoin_name_string,
            t.user_id,
            u.realname AS audit_user_name,
            #{attType} as attachment_type,
             p.user_id AS moderator_id,
             p.participant_id AS moderator_data_id,
             d3.NAME AS audit_org_name,
             (SELECT `name` FROM sys_dept where dept_id = d.parent_id)AS superiorName,
            'IMAGE' AS file_type_img,
            'DOCUMENT' AS file_type_doc,
            'VIDEO' AS file_type_video
        FROM
            tab_pb_activities a
            LEFT JOIN sys_dept d ON a.org_id = d.dept_id
            LEFT JOIN sys_dept d3 ON a.audit_org = d3.dept_id
            LEFT JOIN sys_user u ON a.audit_user = u.user_id
            LEFT JOIN tab_pb_participant p ON a.activities_id = p.activities_id AND p.if_moderator = 1 and p.del_flag=0
            LEFT JOIN (
            SELECT
                 p.activities_id AS activities_id,
                GROUP_CONCAT( CASE WHEN p.absent_reason = 0 THEN p.real_name ELSE NULL END ) AS join_name_string,
                GROUP_CONCAT( CASE WHEN p.absent_reason > 0 THEN p.real_name ELSE NULL END ) AS unjoin_name_string,
                GROUP_CONCAT(p.user_id) AS user_id
            FROM
                tab_pb_participant p  WHERE p.del_flag=0 AND p.if_moderator = 0
            GROUP BY
                p.activities_id
            ) t ON t.activities_id = a.activities_id
        WHERE
            a.activities_id = #{activitiesId}
            AND a.del_flag = 0
    </select>

    <select id="selectByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
        ac.*
        FROM
        tab_pb_activities AS ac
        INNER JOIN tab_pb_participant AS pa ON ac.activities_id = pa.activities_id
        WHERE
        pa.user_id = #{userId}
        AND ac.del_flag = 0
        AND pa.del_flag = 0
        AND pa.if_link_leader = 1
    </select>

    <!--根据条件查询结对共建列表-->
    <select id="selectPairingListWithConditions" parameterType="java.util.Map" resultMap="PairingResultMap">
        SELECT
          a.*,
          d.name AS org_name,
          d1.name AS pair_org_name
        FROM tab_pb_activities a
        LEFT JOIN sys_dept d ON a.org_id = d.dept_id OR a.org_id = d.partner_org_id
        LEFT JOIN sys_dept d1 ON d1.dept_id = d.partner_org_id
        <where>
            <include refid="Pairing_Base_WhereCase_List"/>
        </where>
    </select>

    <!--结对共建详情-->
    <select id="selectPairingDetail" parameterType="java.util.Map" resultMap="PairingResultMapWithAnnex">
      SELECT
            a.*,
            d.NAME AS org_name,
            d.partner_org_id AS pair_org_id,
            d2.NAME AS pair_org_name,
            p.real_name AS moderator_name,
            p.user_id AS moderator_id,
            p.participant_id AS moderator_data_id,
            t.join_name_string,
            t.unjoin_name_string,
            u.realname AS audit_user_name,
            d3.NAME AS audit_org_name,
            '41' as attachment_type,
            'IMAGE' AS file_type_img,
            'DOCUMENT' AS file_type_doc,
            'VIDEO' AS file_type_video
        FROM
            tab_pb_activities a
            LEFT JOIN sys_dept d ON a.org_id = d.dept_id
            LEFT JOIN sys_dept d2 ON d.partner_org_id = d2.dept_id
            LEFT JOIN sys_dept d3 ON a.audit_org = d3.dept_id
            LEFT JOIN sys_user u ON a.audit_user = u.user_id
            LEFT JOIN tab_pb_participant p ON a.activities_id = p.activities_id AND p.if_moderator = 1 AND p.del_flag = 0
            LEFT JOIN (
            SELECT
                p.activities_id AS activities_id,
                GROUP_CONCAT( CASE WHEN p.absent_reason = 0 THEN p.real_name ELSE NULL END ) AS join_name_string,
                GROUP_CONCAT( CASE WHEN p.absent_reason > 0 THEN p.real_name ELSE NULL END ) AS unjoin_name_string
            FROM
                tab_pb_participant p WHERE p.del_flag=0 AND p.if_moderator = 0
            GROUP BY
                p.activities_id
            ) t ON t.activities_id = a.activities_id
        WHERE
            a.activities_id = #{activitiesId}
            AND a.del_flag = 0
    </select>

    <!--根据ID查询单个-->
    <select id="selectOneById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT * FROM tab_pb_activities WHERE activities_id = #{activitiesId} and del_flag = 0
    </select>

    <!--活动审核/重审-->
    <update id="review" parameterType="com.yizheng.partybuilding.entity.TabPbActivities">
        UPDATE tab_pb_activities a
        LEFT JOIN tab_pb_participant p  ON a.activities_id = p.activities_id
        SET a.audit_result = #{auditResult}, p.parent_org_assess = #{auditResult}, a.audit_time = #{auditTime}, p.audit_time = #{auditTime},
          a.audit_user = #{auditUser}, p.audit_user = #{auditUser}, a.audit_org = #{auditOrg}, p.audit_org = #{auditOrg},
          a.audit_comment = #{auditComment}, p.audit_comment = #{auditComment}, a.update_userid = #{updateUserid}, p.update_userid = #{updateUserid},
          a.update_username = #{updateUsername}, p.update_username = #{updateUsername}, a.update_time = #{updateTime}, p.update_time = #{updateTime}
        WHERE a.del_flag = 0 AND a.activities_id = #{activitiesId}
    </update>

    <!--根据组织和活动类型删除活动-->
    <update id="deleteByOrgIdAndActivityType" parameterType="com.yizheng.partybuilding.entity.TabPbActivities">
        UPDATE tab_pb_activities A
        INNER JOIN tab_pb_participant B ON A.activities_id = B.activities_id
        SET A.del_flag = #{delFlag}, B.del_flag =#{delFlag}
        WHERE
            A.org_id =#{orgId} AND A.activities_type = #{activitiesType}
    </update>

    <select id="ActivitiesDtoList" parameterType="com.yizheng.partybuilding.entity.TabPbActivities"
            resultMap="TabPbActivitiesDtoMap">
        SELECT
            u.realname AS username,
            dept.`name` ,
            u.report_org_id,
            a.`subject`,
            a.activities_type,
            a.activities_type_ids,
            a.activities_id,
            a.create_time,
            t.name AS report_org_name,
            t.dept_id,
            ifnull( vac.video_num, 0 ) video,
            ifnull( vac.img_num, 0 ) photo,
            ifnull( vac.doc_num, 0 ) doc
        FROM (
            SELECT
                pr.user_id,
                p.activities_id,
                d.NAME,
                d.dept_id
            FROM
            tab_pb_positive_regist pr
            INNER JOIN sys_dept d ON pr.dept_id = d.dept_id
            INNER JOIN tab_pb_participant p ON pr.user_id = p.user_id
            WHERE
                pr.del_flag = 0
                AND d.del_flag = 0
                AND p.del_flag = 0
            <if test="orgRange != null and orgRange != ''">
                <choose>
                    <when test="orgRange == 1">
                        AND (d.dept_id = #{rangeDeptId} OR d.parent_id = #{rangeDeptId})
                    </when>
                    <when test="orgRange == 2">
                        AND find_in_set(#{rangeDeptId}, d.full_path)
                    </when>
                </choose>
            </if>
            <if test="orgRange == null or orgRange.toString() == ''">
                AND d.dept_id = #{rangeDeptId}
            </if>
        ) t
        INNER JOIN tab_pb_activities a ON t.activities_id = a.activities_id
        INNER JOIN sys_user u ON t.user_id = u.user_id
        LEFT JOIN view_attachment_count vac ON t.activities_id = vac.host_id
        AND vac.attachment_type IN ( 30, 31, 32, 33, 34, 35, 37 )
        INNER JOIN sys_dept dept ON dept.dept_id = u.dept_id
        <where>
            a.del_flag = 0
            AND u.del_flag = 0
            AND dept.del_flag = 0
            <if test="subject != null and subject != ''">
                AND a.subject LIKE CONCAT('%',#{subject},'%')
            </if>
            <if test="username != null and username != ''">
                AND u.realname LIKE CONCAT('%',#{username},'%')
            </if>
            <if test="activitiesType != null ">
                AND (a.activities_type = #{activitiesType} or find_in_set(#{activitiesType}, a.activities_type_ids))
            </if>
        </where>
    </select>

    <!--查询活动排除参与者列表 （年老体弱者/常年外出者）-->
    <select id="selectExclusionMemberList" resultMap="ExclusionMemberResultMap">
        SELECT
        d.dept_id AS org_id,
        d.name AS org_name,
        '59388' AS nltr,
        '59389' AS jcwc
        <choose>
            <when test="pairOrgId != null and pairOrgId != ''">
                ,#{pairOrgId} AS pair_org_id,
                (SELECT innerD.`name` FROM sys_dept innerD WHERE innerD.dept_id = #{pairOrgId}) AS pair_org_name
            </when>
            <otherwise>
                ,null AS pair_org_id,
                '' AS pair_org_name
            </otherwise>
        </choose>
        FROM sys_dept d
        WHERE d.dept_id = #{orgId}
    </select>

    <!--根据条件查询活动候选人列表-->
    <select id="selectCandidateMemberListWithConditions" parameterType="java.util.Map"
            resultType="com.yizheng.partybuilding.dto.Personnel">
        SELECT
            d.dept_id AS orgId,
            d.NAME AS orgName,
            t.`type`,
            u.user_id AS userId,
            u.realname AS username,
            u.gender,
            u.id_card_no AS idCardNo
        FROM (
            SELECT
                user_id,
                group_concat( type ) `type`
            FROM (
                SELECT u.user_id, '59384' AS `type` <!--流动党员-->
                FROM sys_user u
                <where>
                    AND u.del_flag = 0 AND u.flow_status = 41207
                    <if test="orgId != null and orgId != '' and (pairOrgId == null or pairOrgId == '')">
                        AND u.flow_to_org_id = #{orgId}
                    </if>
                    <if test="pairOrgId != null and pairOrgId != '' and orgId != null and orgId != ''">
                        AND (u.flow_to_org_id = #{orgId} OR u.flow_to_org_id = #{pairOrgId})
                    </if>
                </where>
              UNION
                SELECT u.user_id, '59383' AS `type` <!--在职党员-->
                FROM sys_user u
                <where>
                    AND u.del_flag = 0
                    <if test="orgId != null and orgId != '' and (pairOrgId == null or pairOrgId == '')">
                        AND u.report_org_id = #{orgId}
                    </if>
                    <if test="pairOrgId != null and pairOrgId != '' and orgId != null and orgId != ''">
                        AND (u.report_org_id = #{orgId} OR u.report_org_id = #{pairOrgId})
                    </if>
                </where>
              UNION
                SELECT u.user_id, '59410' AS `type` <!--直属党员-->
                FROM sys_user u
                <where>
                    AND u.del_flag = 0
                    <if test="orgId != null and orgId != '' and (pairOrgId == null or pairOrgId == '')">
                        AND u.dept_id = #{orgId}
                    </if>
                    <if test="pairOrgId != null and pairOrgId != '' and orgId != null and orgId != ''">
                        AND (u.dept_id = #{orgId} OR u.dept_id = #{pairOrgId})
                    </if>
                </where>
            ) tt
            GROUP BY tt.user_id
        ) t
        INNER JOIN sys_user u ON t.user_id = u.user_id
        LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
        <where>
            u.del_flag = 0
            <if test="userTag != null and userTag != '' and (exclusion == null or exclusion == '')">
                AND EXISTS (SELECT 1 FROM tab_pb_user_tag ut WHERE ut.user_id = u.user_id AND ut.tag_type = #{userTag})
            </if>
            <if test="userTag != null and userTag != '' and exclusion != null and exclusion != ''">
                AND NOT EXISTS (SELECT 1 FROM tab_pb_user_tag ut WHERE ut.user_id = u.user_id AND find_in_set(ut.tag_type, #{userTag}))
            </if>
            <if test="userIds != null and userIds != ''">
                AND NOT find_in_set(u.user_id, #{userIds})
            </if>
        </where>
    </select>

    <!--根据条件查询联席会活动获选参会人员列表-->
    <select id="selectJoinMeetActivitiesPreUserListWithConditions" resultMap="JoinMeetActivitiesPreUserResultMap">
        SELECT
        d.dept_id AS org_id,
        d.NAME org_name,
        d.unit_id,
        d.unit_name,
        m.positive_id,
        m.positive_name,
        m.user_id,
        m.person_name AS user_name,
        u.id_card_no
        <if test="activitiesId != null and activitiesId != ''
               and (exclude == null or exclude == '')">
            ,p.participant_id
        </if>
        FROM
        tab_pb_joint_meet jm
        INNER JOIN tab_pb_joint_meet_org b ON jm.joint_meet_id = b.joint_meet_id
        INNER JOIN tab_pb_lead_team t ON b.org_id = t.org_id AND t.current = 1
        INNER JOIN tab_pb_lead_team_member m ON t.lead_team_id = m.lead_team_id
        INNER JOIN sys_dept d ON m.org_id = d.dept_id
        INNER JOIN sys_user u ON m.user_id = u.user_id
        <if test="activitiesId != null and activitiesId != ''
               and (exclude == null or exclude == '')">
            INNER JOIN tab_pb_participant p ON m.user_id = p.user_id AND p.if_moderator != 1 AND activities_id = #{activitiesId}
        </if>
        WHERE jm.del_flag = 0 AND b.del_flag = 0 AND t.del_flag = 0 AND m.del_flag = 0
        <if test="orgId != null and orgId != ''">
            AND jm.org_id = #{orgId}
        </if>
        <if test="userName != null and userName != ''">
            AND m.person_name like concat('%',#{userName},'%')
        </if>
        <if test="idCardNo != null and idCardNo != ''">
            AND u.id_card_no = #{idCardNo}
        </if>
        <if test="activitiesId != null and activitiesId != ''
               and exclude != null and exclude != ''">
            AND NOT EXISTS (
            SELECT 1 FROM tab_pb_participant p
            WHERE p.activities_id = #{activitiesId} AND del_flag = 0 AND p.user_id = m.user_id
            )
        </if>
    </select>

    <!--根据用户id查询活动列表-->
    <select id="selectListByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
          a.*,
          d.name AS org_name
        FROM tab_pb_participant p
        INNER JOIN tab_pb_activities a ON a.activities_id = p.activities_id
        LEFT JOIN sys_dept d ON a.org_id = d.dept_id
        WHERE p.user_id = #{userId}
            AND p.del_flag = 0
            AND a.del_flag = 0
        ORDER BY a.create_time DESC
    </select>
    <!--添加访问量-->
    <update id="updateOrderNum" parameterType="java.lang.Long">
        update tab_pb_activities set order_num =order_num + 1 where activities_id = #{activitiesId}
    </update>

    <!--置顶功能-->
    <update id="stick" parameterType="java.lang.Long">
        update tab_pb_activities set stick_num =#{stickNum}+1 where activities_id = #{activitiesId}
    </update>

    <!--查询最大访问量-->
    <select id="findByOrderNum" resultType="java.lang.Long">
        select MAX(stick_num) FROM tab_pb_activities
    </select>

    <!--取消置顶功能-->
    <update id="deleteStick" parameterType="java.lang.Long">
        update tab_pb_activities set stick_num =0 where activities_id = #{activitiesId}
    </update>
</mapper>

